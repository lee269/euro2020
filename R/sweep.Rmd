---
title: "FCAT Euro2020 Sweep"
output: 
  html_document:
    toc: TRUE
    toc_float: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

library(tibble)
library(tidyr)
library(dplyr)
library(here)
library(readr)
library(purrr)
library(reactable)

seed = 75229
groups <- c("Group A", "Group B", "Group C", "Group D", "Group E", "Group F")

matchdata <- read_csv(here("data", "matchdata.csv"))

matchdata_wide <- matchdata %>% 
  pivot_wider(names_from = homeaway,
              values_from = c(team, goals, penalties, ycards, rcards, fouls)) %>% 
  mutate(points_hometeam = case_when(goals_hometeam > goals_awayteam ~ 3,
                                     goals_hometeam == goals_awayteam ~ 1,
                                     TRUE ~ 0),
         points_awayteam = case_when(goals_awayteam > goals_hometeam ~ 3,
                                     goals_awayteam == goals_hometeam ~ 1,
                                     TRUE ~ 0))


hometeam <- matchdata_wide %>% 
            select(matchnumber, roundnumber, date, location, group,
                   team = team_hometeam,
                   goals_for = goals_hometeam,
                   goals_against = goals_awayteam,
                   penalties = penalties_hometeam,
                   ycards = ycards_hometeam,
                   rcards = rcards_hometeam,
                   fouls = fouls_hometeam,
                   points = points_hometeam)

awayteam <- matchdata_wide %>% 
  select(matchnumber, roundnumber, date, location, group,
         team = team_awayteam,
         goals_for = goals_awayteam,
         goals_against = goals_hometeam,
         penalties = penalties_awayteam,
         ycards = ycards_awayteam,
         rcards = rcards_awayteam,
         fouls = fouls_awayteam,
         points = points_awayteam)

matches <- hometeam %>% 
           bind_rows(awayteam)

```

Welcome to the FCAT Euro2020 Sweep! Your chance to add a little spice to your
summer and maybe win a valuable Cash[^1] Prize! As usual there are a range of
prizes available to maximise the chances of prolonging your interest.

- **Winner** receives £10 worth of FCAT fun points
- **Runner up** gets £5

In addition there are some bonus categories with a value of £3 each:

- **Wooden Spoon** for the worst team in the tournament based on results
- **Entertainers** for the team involved in the most goals
- **Thugs** for the dirtiest team

All statistics will be drawn from the official
[Euro2020](https://www.uefa.com/uefaeuro-2020/) website. The organisers reserve
the right to tweak the criteria for the bonus categories, to break ties or
generally to keep it sensible. As always in case of questions over the rules,
the organisers decision is _final_.

[^1]: Well, not real cash since we are not collecting stake money. But you will
get a warm fuzzy feeling inside.

## The Draw

The draw has been conducted in a rigorously reproducible manner, seeded with a
random number. The random seed used, _`r format(seed, digits = 3)`_, was
generated by Maria, Matt, Michael, Nick and Nina in the FCAT meeting on 9^th^
June: blame them. The code to reproduce it is below.

```{r sweep, message=FALSE}

names <- c("Michael Archer", "Matthew Bardrick", "Nick Boase", "Zoe Donkin",
           "Luke Hamilton", "Catharine Hammond", "Eleanor Harris", "Courtney Keane", 
           "Jenny Kemp", "George Koutsoumanis", "David Lee", "Nafisa Mathia", 
           "Molly O'Connor", "Maria Prokopiou", "Nina Sal", "Andrew Scaife",
           "Barsha Sharma", "Christopher Silwood", "Jonathan Smith", "Isabella Worth",
           "Shak Shah", "Ian Lonsdale", "Marcia Bogle", "Tom Powell")  

countries <- c("Italy", "Switzerland", "Turkey", "Wales",
               "Belgium", "Russia", "Denmark", "Finland",
               "Ukraine", "Netherlands", "Austria", "North Macedonia",
               "England", "Croatia", "Czech Republic", "Scotland",
               "Spain", "Poland", "Sweden", "Slovakia", 
               "Germany", "France", "Portugal", "Hungary")

seed = 75229
set.seed(seed)
draw <- tibble(country = sample(countries), name = names) %>% 
  arrange(country)

knitr::kable(draw)

```

## The Prizes {.tabset .tabset-pills}

### Wooden Spoon

This was a hotly contested category, with North Macedonia making a strong case
in their first ever tournament finals. Ultimately, though **Turkey** are the
turkeys from the group stage, with no points scored, shipping 8 goals and only
scoring one of their own. Congratulations **Michael!**

```{r wooden-spoon, echo=FALSE}

matches %>% 
  na.omit() %>% 
  filter(group %in% groups) %>%
  group_by(team) %>% 
  summarise(played = n(),
            goals_for = sum(goals_for),
            goals_against = sum(goals_against),
            goals_sum = sum(goals_for) + sum(goals_against),
            goal_diff = sum(goals_for) - sum(goals_against),
            pts = sum(points)) %>% 
  arrange(pts, goal_diff) %>% 
  reactable(pagination = TRUE,
            compact = TRUE,
            columns = list(
              team = colDef(name = "Team"),
              played = colDef(name = "Matches played"),
              goals_for = colDef(name = "Goals for"),
              goals_against = colDef(name = "Goals against"),
              goals_sum = colDef(name = "Goals total"),
              goal_diff = colDef(name = "Goal difference")
            ) )


```

### Entertainers

The entertainment index is the total goals per game plus goals for per game,
with the tie breaker being the number of goals scored (because we all want to
see some buccaneering all out attacking football). You might notice that England
have not exactly been setting the world alight in this regard.

``` {r entertainers, echo=FALSE}

matches %>% 
  na.omit() %>% 
  group_by(team) %>% 
  summarise(played = n(),
            goals_for = sum(goals_for),
            goals_against = sum(goals_against),
            goals_sum = sum(goals_for) + sum(goals_against),
            goal_diff = sum(goals_for) - sum(goals_against),
            entertain_index = (goals_sum / played) + (goals_for / played)) %>% 
  arrange(-entertain_index, -goals_for) %>% 
  reactable(pagination = TRUE, 
            compact = TRUE,
            columns = list(
              team = colDef(name = "Team"),
              played = colDef(name = "Matches played"),
              goals_for = colDef(name = "Goals for"),
              goals_against = colDef(name = "Goals against"),
              goals_sum = colDef(name = "Goals total"),
              goal_diff = colDef(name = "Goal difference"),
              entertain_index = colDef(name = "Entertainment Index", format = colFormat(digits = 2))
            ))



```


### Thugs

The 'thug index' is calculated as follows: a red card is 25pts, a yellow 5pts
and a foul 1. These weights are applied to the match data and divided by the
number of matches played.

```{r thugs, echo=FALSE}

matches %>% 
  na.omit() %>% 
  group_by(team) %>% 
  summarise(played = n(),
            ycards = sum(ycards),
            rcards = sum(rcards),
            fouls = sum(fouls),
            thug_index = ((rcards * 25) + (ycards *5) + fouls) / played) %>% 
  arrange(-thug_index) %>% 
  reactable(pagination = TRUE,
            compact = TRUE,
            columns = list(
              team = colDef(name = "Team"),
              played = colDef(name = "Matches played"),
              ycards = colDef(name = "Yellow cards"),
              rcards = colDef(name = "Red cards"),
              fouls = colDef(name = "Fouls"),
              thug_index = colDef(name = "Thug index", format = colFormat(digits = 2))
            ))

```

## The tournament {.tabset}

### Group stages 


```{r groups, echo=FALSE, message=FALSE, results='asis'}

league_table <- function(groupname) {
matches %>% 
  na.omit() %>% 
  filter(group == groupname) %>%
  group_by(team) %>% 
  summarise(played = n(),
            goals_for = sum(goals_for),
            goals_against = sum(goals_against),
            goals_sum = sum(goals_for) + sum(goals_against),
            goal_diff = sum(goals_for) - sum(goals_against),
            ycards = sum(ycards),
            rcards = sum(rcards),
            thug_index = sum(rcards) *2 + sum(ycards),
            fouls = sum(fouls),
            pts = sum(points)) %>% 
  arrange(-pts, -goal_diff) %>% 
    knitr::kable(caption = paste0("**",groupname,"**"))
}

map(groups, league_table)

```

### Overall standings

```{r overall}

matches %>% 
  na.omit() %>% 
  group_by(team) %>% 
  summarise(played = n(),
            goals_for = sum(goals_for),
            goals_against = sum(goals_against),
            goals_sum = sum(goals_for) + sum(goals_against),
            goal_diff = sum(goals_for) - sum(goals_against),
            ycards = sum(ycards),
            rcards = sum(rcards),
            fouls = sum(fouls),
            pts = sum(points)) %>% 
  arrange(-pts, -goal_diff) %>% 
  reactable(pagination = FALSE,
            compact = TRUE)



```